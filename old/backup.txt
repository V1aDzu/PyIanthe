üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (Custom Callback)
Callback –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±—É—é —Ñ—É–Ω–∫—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏) —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ Trainer —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Å–≤–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —á–µ–∫–ø–æ–∏–Ω—Ç. –≠—Ç–æ –ª—É—á—à–µ–µ –∏ —Å–∞–º–æ–µ "—á–∏—Å—Ç–æ–µ" —Ä–µ—à–µ–Ω–∏–µ.

1. –ö–æ–¥ Custom Callback
–°–æ–∑–¥–∞–¥–∏–º –∫–ª–∞—Å—Å BackupCallback, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏ –∏ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞.

Python

import os
import shutil
from transformers import TrainerCallback

class BackupCallback(TrainerCallback):
    """
    Callback –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–æ–ª—å–∫–æ –≤–µ—Å–æ–≤ –º–æ–¥–µ–ª–∏
    –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø–∞–ø–∫–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —á–µ–∫–ø–æ–∏–Ω—Ç–∞.
    """
    def __init__(self, backup_dir, total_backup_limit=3):
        self.backup_dir = backup_dir
        self.total_backup_limit = total_backup_limit
        os.makedirs(self.backup_dir, exist_ok=True)

    def on_save(self, args, state, control, **kwargs):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ–∫–ø–æ–∏–Ω—Ç–∞."""
        
        # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –¥–ª—è –Ω–æ–≤–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        backup_name = f"model_backup_step-{state.global_step}"
        backup_path = os.path.join(self.backup_dir, backup_name)
        
        # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¢–û–õ–¨–ö–û –≤–µ—Å–∞ –∏ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä
        # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞, 
        # –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º –∫–æ–¥–æ–º.
        model_to_save = kwargs['model']
        tokenizer = kwargs['tokenizer']
        
        model_to_save.save_pretrained(backup_path)
        if tokenizer is not None:
            tokenizer.save_pretrained(backup_path)
            
        print(f"\n[BACKUP] –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {backup_path}")
        
        # 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–º: —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–ø–∏–∏
        self._manage_backup_limit()

    def _manage_backup_limit(self):
        """–£–¥–∞–ª—è–µ—Ç —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç."""
        all_backups = sorted([
            d for d in os.listdir(self.backup_dir) 
            if os.path.isdir(os.path.join(self.backup_dir, d))
        ])
        
        if len(all_backups) > self.total_backup_limit:
            oldest_backup = all_backups[0]
            oldest_path = os.path.join(self.backup_dir, oldest_backup)
            shutil.rmtree(oldest_path)
            print(f"[BACKUP] –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {oldest_path}")

2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Trainer
–¢–µ–ø–µ—Ä—å –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç Callback –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Trainer.

Python

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
BACKUP_DIR = "./safe_archives"

# 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—à Callback
backup_callback = BackupCallback(
    backup_dir=BACKUP_DIR, 
    total_backup_limit=5  # –•—Ä–∞–Ω–∏—Ç—å 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –≤–µ—Å–æ–≤
)

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Trainer —Å –Ω–∞—à–∏–º Callback
trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_datasets["train"],
    # ... –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ...
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à Callback
    callbacks=[backup_callback] 
)

# 3. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ
trainer.train()
3. –ö–∞–∫ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è —Å –ü–æ–º–æ—â—å—é –†–µ–∑–µ—Ä–≤–Ω–æ–π –ö–æ–ø–∏–∏
–ï—Å–ª–∏ –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —á–µ–∫–ø–æ–∏–Ω—Ç (checkpoint-N) –∏ –∞–≤–∞—Ä–∏–π–Ω—ã–π —á–µ–∫–ø–æ–∏–Ω—Ç –∏—Å–ø–æ—Ä—Ç–∏–ª–∏—Å—å, –Ω–æ —É –≤–∞—Å –µ—Å—Ç—å –ø–∞–ø–∫–∞ safe_archives/model_backup_step-N:

–ó–∞–≥—Ä—É–∂–∞–µ—Ç–µ –≤–µ—Å–∞ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –ø–∞–ø–∫–∏ (—ç—Ç–æ —Å–ø–∞—Å–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞):

Python

model = AutoModelForSequenceClassification.from_pretrained(
    "./safe_archives/model_backup_step-N"
)
–ó–∞–ø—É—Å–∫–∞–µ—Ç–µ –æ–±—É—á–µ–Ω–∏–µ —Å –Ω—É–ª—è (trainer.train()):

–í—ã —Ç–µ—Ä—è–µ—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞, –∏ —Å—á–µ—Ç—á–∏–∫ —à–∞–≥–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –Ω—É–ª—è.

–í—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –≤—Å–µ –Ω–∞—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Å–∞ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç–µ —Ñ–∞–π–Ω-—Ç—é–Ω–∏–Ω–≥ —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞, —á—Ç–æ –±—ã–ª–æ 2-3 –¥–Ω—è –Ω–∞–∑–∞–¥ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π).

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –¥–∞–µ—Ç –≤–∞–º —Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω—É—é —Å–µ—Ç–∫—É –ø—Ä–æ—Ç–∏–≤ –¥–≤—É—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º: –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∫–æ–¥–∞. –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –µ—â–µ –±–æ–ª—å—à–µ –∑–∞—â–∏—Ç—ã, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ save_strategy="steps" –∏ save_total_limit=2 –≤ TrainingArguments, —á—Ç–æ–±—ã –∏–º–µ—Ç—å —á–∞—Å—Ç—ã–µ, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —á–µ–∫–ø–æ–∏–Ω—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∞ Callback –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –≤–∞—à –Ω–∞–¥–µ–∂–Ω—ã–π "—Å–µ–π—Ñ".